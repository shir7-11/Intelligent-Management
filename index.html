<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS Dept. Intelligent Work Management</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ğŸŸ¢ å…¨å±€åŸºç¡€ä¸å˜é‡ */
        :root { 
            --primary: #2d3748;
            --accent: #4299e1;
            --success: #48bb78;
            --warning: #ed8936;
            --danger: #f56565;
            --bg: #f7fafc;
            --white: #ffffff; 
            --font-stack: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        body { 
            font-family: var(--font-stack); 
            background: var(--bg); 
            color: #4a5568; 
            margin: 0; 
            padding: 20px; 
            font-size: 13px; 
            line-height: 1.6; 
            -webkit-font-smoothing: antialiased;
        }
        .container { max-width: 98%; margin: 0 auto; display: none; }
        
        /* ğŸŸ¢ é¡¶éƒ¨å¯¼èˆª */
        header { 
            background: rgba(255, 255, 255, 0.85); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
            padding: 12px 24px; 
            border-radius: 12px; 
            box-shadow: var(--shadow-md); 
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 24px; 
            border-top: none; 
            position: sticky; top: 10px; z-index: 100;
            border: 1px solid rgba(255,255,255,0.6);
        }
        .brand h1 { margin: 0; font-size: 20px; color: var(--primary); font-weight: 800; letter-spacing: -0.5px; display: flex; align-items: center; gap: 10px; }
        
        .view-switcher { display: flex; background: #edf2f7; padding: 4px; border-radius: 8px; }
        .view-btn { 
            padding: 6px 18px; border: none; background: transparent; cursor: pointer; font-size: 13px; border-radius: 6px; 
            color: #718096; font-weight: 600; font-family: var(--font-stack); transition: all 0.2s ease; 
        }
        .view-btn.active { background: var(--white); color: var(--accent); box-shadow: var(--shadow-sm); transform: scale(1.02); }
        .view-btn:hover:not(.active) { color: var(--primary); }
        
        /* æ§ä»¶ä¸è¾“å…¥æ¡† */
        .controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        select, input.search, input[type="month"] { 
            padding: 8px 14px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 13px; outline: none; 
            font-family: var(--font-stack); background: white; transition: all 0.2s ease; box-shadow: var(--shadow-sm);
        }
        select:focus, input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.15); }
        input.search { width: 180px; }
        
        /* æŒ‰é’®ç³»ç»Ÿ */
        .btn { 
            padding: 8px 18px; border: none; border-radius: 8px; cursor: pointer; color: white; font-size: 13px; font-weight: 600; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); display: inline-flex; align-items: center; gap: 6px; 
            font-family: var(--font-stack); box-shadow: 0 2px 4px rgba(0,0,0,0.08); 
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.12); opacity: 1; filter: brightness(1.05); }
        .btn:active { transform: scale(0.96); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        
        .btn-add { background: var(--accent); } 
        .btn-export { background: var(--success); } 
        .btn-refresh { background: #a0aec0; } 
        .btn-config { background: #4a5568; } 
        .btn-present { background: #9f7aea; } 
        
        .action-group { display: flex; gap: 6px; justify-content: flex-end; }
        .btn-edit { background: #ecc94b; color: #744210; padding: 4px 10px; font-size: 11px; border-radius: 6px; border:none; cursor:pointer; font-weight:600;}
        .btn-del { background: #fed7d7; color: #c53030; padding: 4px 10px; font-size: 11px; border-radius: 6px; border:none; cursor:pointer; font-weight:600;}

        #listView, #dashboardView, #kanbanView, #schedulerView { display: none; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .show-view { display: block !important; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* è¡¨æ ¼æ ·å¼ */
        .table-box { background: var(--white); border-radius: 12px; box-shadow: var(--shadow-lg); overflow-x: auto; border: 1px solid rgba(255,255,255,0.5); }
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 1200px; }
        thead { background: #f8fafc; }
        th { text-align: left; padding: 16px 20px; border-bottom: 2px solid var(--border-color); color: #718096; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; }
        td { padding: 14px 20px; border-bottom: 1px solid var(--border-color); font-size: 13px; vertical-align: middle; color: #2d3748; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background-color: #f7fafc; }
        
        /* æ ‡ç­¾ä½“ç³» */
        .tag { display: inline-flex; align-items: center; padding: 3px 10px; border-radius: 6px; font-size: 11px; margin-right: 6px; margin-bottom: 4px; font-weight: 600; border: 1px solid transparent;}
        .tag-loc { background: #ebf8ff; color: #2b6cb0; border-color: #bee3f8; font-weight: 500; }
        .tag-person { background: #edf2f7; color: #4a5568; border-color: #e2e8f0; font-weight: 500; border-radius: 20px;}
        .tag-weekend { background: #fffaf0; color: #dd6b20; border-color: #feebc8; }
        .tag-holiday { background: #fff5f5; color: #c53030; border-color: #fed7d7; font-weight: 700; }
        .tag-makeup { background: #f7fafc; color: #4a5568; border: 1px solid #cbd5e0; font-weight: 700; }
        .tag-duration { background: #b794f4; color: white; border-radius: 20px; padding: 1px 8px; font-size: 10px; margin-left: 5px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .tag-type { font-weight: 700; border-radius: 6px; padding: 3px 10px; font-size: 11px; display: inline-flex; align-items: center; gap: 4px; }
        .tag-pm { background: #e6fffa; color: #285e61; border: 1px solid #b2f5ea; }
        .tag-project { background: #faf5ff; color: #553c9a; border: 1px solid #e9d8fd; }
        .tag-adhoc { background: #fffaf0; color: #9c4221; border: 1px solid #fbd38d; }

        .pagination { display: flex; justify-content: flex-end; align-items: center; padding: 15px 24px; gap: 10px; background: #fff; border-top: 1px solid var(--border-color); }
        .page-btn { padding: 6px 14px; border: 1px solid #e2e8f0; background: white; cursor: pointer; border-radius: 6px; font-size: 13px; color: #4a5568; transition: all 0.2s; }
        .page-btn:hover:not(:disabled) { background: #f7fafc; border-color: #cbd5e0; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-info { font-size: 13px; color: #718096; }
        
        /* æ’ç¨‹è§†å›¾å®¹å™¨ */
        .scheduler-container { padding: 24px; background: white; border-radius: 12px; box-shadow: var(--shadow-lg); border: 1px solid rgba(255,255,255,0.5); }
        .scheduler-header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #edf2f7; }
        .scheduler-title { font-size: 18px; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 12px; letter-spacing: -0.5px; }
        
        /* ğŸŸ¢ æ’ç¨‹å›¾ä¾‹ */
        .scheduler-legend { display: flex; gap: 16px; font-size: 12px; color: #718096; }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .legend-color { width: 12px; height: 12px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.05); }
        
        /* ğŸŸ¢ æ’ç¨‹è¡¨æ ¼åŸºç¡€æ ·å¼ */
        .scheduler-table th, .scheduler-table td { border: 1px solid #dcdcdc; text-align: center; padding: 4px; height: 50px; vertical-align: top; }
        
        /* ğŸŸ¢ è¡¨å¤´æ ·å¼ */
        .scheduler-table th { 
            background: #f8fafc; color: #4a5568; position: sticky; top: 0; z-index: 10; 
            font-size: 12px; font-weight: 600; 
            height: 48px; /* å¢åŠ é«˜åº¦ä»¥å®¹çº³æ˜ŸæœŸ */
            line-height: 1.3;
            vertical-align: middle; border-bottom: 2px solid #e2e8f0; 
        }
        
        .scheduler-table .col-person { position: sticky; left: 0; background: #fff; z-index: 5; border-right: 2px solid #cbd5e0; width: 110px; font-weight: 600; vertical-align: middle; color: #2d3748; box-shadow: 4px 0 6px -2px rgba(0,0,0,0.02); }
        
        /* ğŸŸ¢ é»˜è®¤å•å…ƒæ ¼ */
        .scheduler-table td { background-color: #edf2f7; }

        /* ğŸŸ¢ é¢œè‰²åŠ æ·±åŒºåŸŸ (Deepened Colors for TV) */
        
        /* å‘¨æœ« - æ©™è‰²åŠ æ·± */
        .bg-weekend { 
            background-color: #fcebd0 !important; /* æ˜æ˜¾çš„è‚‰è‰²/æ©™è‰² */
            color: #9c4221 !important; 
            border-right: 1px solid #ed8936;
        } 
        
        /* èŠ‚å‡æ—¥ - ç²‰çº¢åŠ æ·±ï¼Œè¾¹æ¡†å˜ç»† */
        .bg-holiday { 
            background-color: #fed7d7 !important; /* æ˜æ˜¾çš„ç²‰çº¢ */
            color: #742a2a !important; 
            border-left: 1px solid #e53e3e !important; /* 1px ç»†çº¿ */
            border-right: 1px solid #e53e3e !important; /* 1px ç»†çº¿ */
        } 
        
        /* è°ƒä¼‘ */
        .bg-makeup { background-color: #ffffff !important; position:relative; } 
        .bg-makeup::after { content: 'ç­'; position: absolute; top: 2px; right: 2px; font-size: 9px; color: #fff; background: #a0aec0; border-radius:3px; padding:0 3px; }
        
        /* ä»Šå¤© - è“è‰²åŠ æ·± */
        .bg-today { 
            background-color: #bee3f8 !important; /* æ˜æ˜¾çš„å¤©è“ */
            border-left: 2px solid #3182ce !important; 
            border-right: 2px solid #3182ce !important; 
        } 
        .th-today { 
            background-color: #3182ce !important; /* è¡¨å¤´æ·±è“ */
            color: white !important; font-weight: bold; font-size: 14px; box-shadow: 0 4px 6px rgba(66, 153, 225, 0.3); border-radius: 4px 4px 0 0; 
        } 

        .scheduler-table td.cell-clickable { cursor: cell; transition: background 0.1s; }
        .scheduler-table td.cell-clickable:hover { filter: brightness(0.95); position: relative; z-index: 2; }

        .sch-task { 
            background: #fff; border-left: 4px solid var(--accent); margin: 3px 2px; padding: 4px 6px; font-size: 11px; text-align: left; border-radius: 4px; /* åœ†è§’å¢åŠ  */
            box-shadow: 0 1px 3px rgba(0,0,0,0.06); cursor: pointer; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; transition: all 0.2s ease;
        }
        .sch-task:hover { transform: translateY(-2px) scale(1.02); z-index: 100; position: relative; width: auto; min-width: 100%; box-shadow: 0 8px 16px rgba(0,0,0,0.15); }
        .sch-task-pm { border-left-color: #38b2ac; background: #e6fffa; color: #234e52; }
        .sch-task-adhoc { border-left-color: #ed8936; background: #fffaf0; color: #7b341e; }
        
        .sch-task-done { 
            border-left-color: #48bb78 !important; 
            background: #f0fff4 !important; 
            color: #22543d !important; 
            font-weight: 600;
            opacity: 0.8;
            text-decoration: line-through;
        }

        .kanban-board { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; height: calc(100vh - 160px); overflow-x: auto; padding-bottom: 20px; } 
        .kanban-col { background: #edf2f7; border-radius: 12px; padding: 16px; display: flex; flex-direction: column; min-width: 280px; border: 1px solid #e2e8f0; box-shadow: inset 0 2px 4px rgba(0,0,0,0.03); }
        .kanban-header { font-weight: 700; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #cbd5e0; display: flex; justify-content: space-between; align-items: center; color: #4a5568; font-size: 14px; letter-spacing: 0.5px; }
        .kanban-count { background: white; border-radius: 20px; padding: 2px 10px; font-size: 11px; color: #718096; box-shadow: 0 1px 2px rgba(0,0,0,0.05); font-weight: 700;}
        .kanban-list { flex: 1; overflow-y: auto; padding-right: 4px; min-height: 100px; }
        .kanban-card { background: white; border-radius: 8px; padding: 16px; margin-bottom: 12px; box-shadow: var(--shadow-sm); cursor: grab; border-left: 4px solid #ccc; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .kanban-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .k-title { font-weight: 600; color: #2d3748; margin-bottom: 8px; line-height: 1.4; }
        .k-meta { display: flex; justify-content: space-between; font-size: 11px; color: #a0aec0; margin-bottom: 8px; }
        .card-Planned { border-left-color: var(--accent); }
        .card-InProgress { border-left-color: var(--warning); }
        .card-Done { border-left-color: var(--success); opacity: 0.7; }
        .card-Overdue { border-left-color: var(--danger); background: #fff5f5; }
        
        .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 24px; }
        .kpi-card { background: white; padding: 24px 30px; border-radius: 16px; box-shadow: var(--shadow-lg); display: flex; align-items: center; justify-content: space-between; border: 1px solid rgba(255,255,255,0.6); transition: transform 0.2s; position:relative; overflow:hidden;}
        .kpi-card::before { content:''; position:absolute; top:0; left:0; width:6px; height:100%; background:currentColor; }
        .kpi-card:hover { transform: translateY(-4px); }
        .kpi-info p { margin: 0 0 8px 0; font-size: 12px; color: #718096; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        .kpi-info h3 { margin: 0; font-size: 32px; color: var(--primary); font-weight: 800; font-variant-numeric: tabular-nums; letter-spacing: -1px; }
        .kpi-icon { font-size: 28px; opacity: 0.8; filter: grayscale(0.2); }
        
        .charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 24px; }
        .chart-box { background: white; padding: 24px; border-radius: 16px; box-shadow: var(--shadow-lg); border: 1px solid rgba(255,255,255,0.6); }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #edf2f7; padding-bottom: 12px; }
        .chart-header h4 { margin: 0; font-size: 16px; color: var(--primary); font-weight: 700; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(29, 39, 49, 0.6); z-index: 1000; backdrop-filter: blur(4px); }
        .modal-content { background: #fff; width: 500px; margin: 6% auto; padding: 32px; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); animation: zoomIn 0.2s ease; }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .form-row { display: flex; gap: 20px; } 
        .form-group { margin-bottom: 18px; flex: 1; }
        .form-group label { display: block; font-weight: 600; font-size: 13px; margin-bottom: 8px; color: #4a5568; }
        .form-group input, .form-group select { width: 100%; padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; font-family: var(--font-stack); font-size: 14px; transition: all 0.2s; }
        .form-group input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.15); }
        .form-group textarea { width: 100%; padding: 10px 14px; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; font-family: var(--font-stack); font-size: 12px; }
        #syncStatus { font-size: 12px; color: #a0aec0; margin-left: 10px; font-weight: 600; }
        
        /* æ¼”ç¤ºæ¨¡å¼æ ·å¼ */
        :fullscreen body, ::backdrop { background: white; overflow: hidden; }
        :fullscreen header, :fullscreen .view-switcher, :fullscreen .controls, :fullscreen .pagination { display: none !important; }
        :fullscreen .container { max-width: 100%; margin: 0; height: 100vh; padding: 16px; display: flex; flex-direction: column; background: #f7fafc; }
        :fullscreen .scheduler-container { box-shadow: none; padding: 16px; height: 100%; display: flex; flex-direction: column; border: none; }
        :fullscreen #schedulerTableWrapper { height: auto !important; flex: 1; overflow: auto; }
        
        @media (max-width: 768px) {
            .kanban-board { grid-template-columns: 1fr; height: auto; overflow-y: auto; }
            .dashboard-grid { grid-template-columns: 1fr 1fr; }
            .charts-row { grid-template-columns: 1fr; }
            header { position: relative; top: 0; }
        }
    </style>
</head>
<body>

<div id="loginOverlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#1a202c;z-index:9999;display:flex;justify-content:center;align-items:center;flex-direction:column;color:white;">
    <h2 style="margin-bottom:8px; font-weight:800; font-size:32px;">ğŸ‘‹ Welcome</h2>
    <h3 style="margin:0 0 30px 0; font-size:16px; font-weight:400; opacity:0.7; letter-spacing:1px;">CS INTELLIGENT WORK MANAGEMENT</h3>
    
    <div style="background:rgba(255,255,255,0.1); padding:30px; border-radius:16px; backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.1);">
        <p style="margin-bottom:15px;opacity:0.9;font-size:14px;font-weight:600;">è¯·è¾“å…¥æ‚¨çš„å§“åç™»è®°è®¿é—®</p>
        <div style="display:flex;gap:12px;">
            <input type="text" id="loginName" placeholder="Name (e.g. Tom)" style="padding:12px 16px;border-radius:8px;border:none;width:200px;font-family:inherit;font-size:14px;background:white;color:#333;">
            <button onclick="checkLogin()" style="padding:12px 24px;background:#4299e1;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:14px;transition:all 0.2s;">Enter</button>
        </div>
    </div>
</div>

<div class="container" id="mainApp">
    <header>
        <div class="brand">
            <h1>CS Dept. Intelligent Work Management</h1>
        </div>
        <div class="view-switcher">
            <button class="view-btn active" onclick="switchView('list')">ğŸ“‹ åˆ—è¡¨ List</button>
            <button class="view-btn" onclick="switchView('scheduler')">ğŸ“… æ’ç¨‹ Scheduler</button>
            <button class="view-btn" onclick="switchView('kanban')">ğŸ—ï¸ çœ‹æ¿ Kanban</button>
            <button class="view-btn" onclick="switchView('dashboard')">ğŸ“Š æŠ¥è¡¨ Dashboard</button>
        </div>
        <div class="controls">
            <span style="font-size:12px;color:#4a5568;font-weight:700;margin-right:8px;">ğŸ‘¤ <span id="displayUser">Guest</span></span>
            <span id="syncStatus">ğŸ”„ Ready</span>
            <div id="listControls" style="display:flex; gap:8px;">
                <div id="schedulerControls" style="display:none; gap:10px;">
                    <button class="btn btn-present" onclick="enterPresentationMode()">ğŸ“º æ¼”ç¤º</button>
                    <input type="month" id="schMonth" onchange="renderScheduler()">
                </div>
                <div id="commonControls" style="display:flex; gap:8px;">
                    <select id="typeFilter" onchange="refreshView()"><option value="">ğŸ“‚ All Types</option><option value="PM">ğŸ› ï¸ PM (é¢„é˜²)</option><option value="Project">ğŸš§ Project (æ–½å·¥)</option><option value="Adhoc">âš¡ Adhoc (æŠ¢ä¿®)</option></select>
                    <select id="locFilter" onchange="refreshView()"><option value="">ğŸ“ Location</option></select>
                    <select id="personFilter" onchange="refreshView()"><option value="">ğŸ‘¤ Person</option></select>
                    <input type="text" class="search" id="searchInput" placeholder="ğŸ” Search..." onkeyup="refreshView()">
                </div>
            </div>
            <button class="btn btn-export" onclick="exportToCSV()">ğŸ“¥ Export</button>
            <button class="btn btn-add" onclick="openModal()">+ New</button>
            <button class="btn btn-refresh" onclick="fetchData()">â†»</button>
            <button class="btn btn-config" onclick="openConfigModal()">âš™ï¸</button>
        </div>
    </header>

    <div id="listView" class="show-view">
        <div class="table-box">
            <table id="mainTable">
                <thead>
                    <tr><th width="18%">æ—¥æœŸ Date</th><th width="8%">ç±»å‹ Type</th><th width="10%">åœ°ç‚¹ Location</th><th width="20%">äº‹ä»¶ Event</th><th width="10%">å·¥å…· Tools</th><th width="15%">å¤‡æ³¨ Remarks</th><th width="10%">äººå‘˜ Person</th><th width="8%">çŠ¶æ€ Status</th><th width="10%">æ“ä½œ Action</th></tr>
                </thead>
                <tbody id="listBody"><tr><td colspan="9" style="text-align:center; padding:30px; color:#999;">Loading...</td></tr></tbody>
            </table>
            <div class="pagination"><span class="page-info" id="pageInfo">Showing 0-0 of 0</span><button class="page-btn" onclick="changePage(-1)" id="prevBtn">Previous</button><button class="page-btn" onclick="changePage(1)" id="nextBtn">Next</button></div>
        </div>
    </div>

    <div id="schedulerView">
        <div class="scheduler-container">
            <div class="scheduler-header-bar">
                <div class="scheduler-title" id="schedulerTitle">2026å¹´ æ’ç¨‹æ€»è§ˆ</div>
                <div class="scheduler-legend">
                    <div class="legend-item"><div class="legend-color" style="background:#bee3f8; border:2px solid #3182ce;"></div> ä»Šå¤©</div>
                    <div class="legend-item"><div class="legend-color" style="background:#fed7d7; border:1px solid #e53e3e;"></div> èŠ‚å‡æ—¥</div>
                    <div class="legend-item"><div class="legend-color" style="background:#fcebd0; border:1px solid #ed8936;"></div> å‘¨æœ«</div>
                    <div class="legend-item"><div class="legend-color" style="background:#edf2f7; border:1px solid #dcdcdc;"></div> å·¥ä½œæ—¥</div>
                </div>
            </div>
            <div id="schedulerTableWrapper" style="height:calc(100vh - 220px); overflow:auto; border:1px solid #e2e8f0; border-radius:8px;">
                <table class="scheduler-table" id="schedulerTable"></table>
            </div>
        </div>
    </div>

    <div id="kanbanView">
        <div class="kanban-board">
            <div class="kanban-col"><div class="kanban-header"><span>ğŸ“… Planned</span><span class="kanban-count" id="count-Planned">0</span></div><div class="kanban-list" id="col-Planned" ondrop="drop(event, 'Planned')" ondragover="allowDrop(event)"></div></div>
            <div class="kanban-col"><div class="kanban-header"><span>â³ In Progress</span><span class="kanban-count" id="count-InProgress">0</span></div><div class="kanban-list" id="col-InProgress" ondrop="drop(event, 'InProgress')" ondragover="allowDrop(event)"></div></div>
            <div class="kanban-col"><div class="kanban-header"><span>âœ… Done</span><span class="kanban-count" id="count-Done">0</span></div><div class="kanban-list" id="col-Done" ondrop="drop(event, 'Done')" ondragover="allowDrop(event)"></div></div>
            <div class="kanban-col"><div class="kanban-header" style="color:#e53e3e"><span>âš ï¸ Overdue</span><span class="kanban-count" id="count-Overdue">0</span></div><div class="kanban-list" id="col-Overdue" ondrop="drop(event, 'Overdue')" ondragover="allowDrop(event)"></div></div>
        </div>
    </div>

    <div id="dashboardView">
        <div class="dashboard-grid">
            <div class="kpi-card" style="color: #4299e1;"><div class="kpi-info"><p>Today's Tasks</p><h3 id="kpi-today">0</h3></div><div class="kpi-icon">ğŸ“…</div></div>
            <div class="kpi-card" style="color: #e53e3e;"><div class="kpi-info"><p style="color:#e53e3e;">âš ï¸ Overdue</p><h3 id="kpi-overdue" style="color:#e53e3e">0</h3></div><div class="kpi-icon">ğŸ”¥</div></div>
            <div class="kpi-card" style="color: #ed8936;"><div class="kpi-info"><p>In Progress</p><h3 id="kpi-progress">0</h3></div><div class="kpi-icon">â³</div></div>
            <div class="kpi-card" style="color: #48bb78;"><div class="kpi-info"><p>Completed</p><h3 id="kpi-done">0</h3></div><div class="kpi-icon">âœ…</div></div>
        </div>
        <div class="charts-row">
            <div class="chart-box"><div class="chart-header"><h4>ğŸ­ å·¥ä½œç±»å‹åˆ†å¸ƒ (Work Type)</h4></div><div style="height: 250px;"><canvas id="chartType"></canvas></div></div>
            <div class="chart-box"><div class="chart-header"><h4>ğŸ’¿ ä»»åŠ¡çŠ¶æ€æ¦‚è§ˆ (Status)</h4></div><div style="height: 250px;"><canvas id="chartStatus"></canvas></div></div>
        </div>
        <div class="charts-row">
            <div class="chart-box"><div class="chart-header"><h4>ğŸ‘¥ äººå‘˜è´Ÿè· (Top Workload)</h4></div><div style="height: 250px;"><canvas id="chartPerson"></canvas></div></div>
            <div class="chart-box"><div class="chart-header"><h4>ğŸ“ åœ°ç‚¹çƒ­åŠ› (Top Locations)</h4></div><div style="height: 250px;"><canvas id="chartLoc"></canvas></div></div>
        </div>
    </div>
</div>

<div id="taskModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0; color:var(--primary); font-weight:800; font-size:24px; margin-bottom:24px;">ğŸ“ ä»»åŠ¡è¯¦æƒ… / Task</h3>
        <input type="hidden" id="editIndex">
        <div class="form-row">
            <div class="form-group"><label>å·¥ä½œç±»å‹</label><select id="inType"><option value="PM">ğŸ› ï¸ PM (é¢„é˜²ç»´æŠ¤)</option><option value="Project">ğŸš§ Project (æ–½å·¥æ”¹é€ )</option><option value="Adhoc">âš¡ Adhoc (ä¸´æ—¶æŠ¢ä¿®)</option></select></div>
            <div class="form-group"><label>æ—¶é—´ (HH:MM)</label><input type="text" id="inTime" placeholder="ä¾‹å¦‚: 14:00"></div>
        </div>
        <div class="form-row" style="background:#f7fafc; padding:15px; border-radius:12px; border:1px solid #edf2f7; margin-bottom:15px;">
            <div class="form-group" style="margin-bottom:0;"><label>å¼€å§‹æ—¥æœŸ (Start Date)</label><input type="text" id="inDate" placeholder="YYYY-MM-DD"></div>
            <div class="form-group" style="margin-bottom:0;"><label>ç»“æŸæ—¥æœŸ (End Date - Optional)</label><input type="text" id="inEndDate" placeholder="YYYY-MM-DD"></div>
        </div>
        <div class="form-group"><label>åœ°ç‚¹ Location</label><input type="text" id="inLoc"></div>
        <div class="form-group"><label>äº‹ä»¶å†…å®¹ Event Content</label><input type="text" id="inEvent" placeholder="Describe the task..."></div>
        <div class="form-row">
            <div class="form-group"><label>æ‰€éœ€å·¥å…· Tools</label><input type="text" id="inTools"></div>
            <div class="form-group"><label>å¤‡æ³¨ Remarks</label><input type="text" id="inRemarks"></div>
        </div>
        <div class="form-group"><label>äººå‘˜ Person (Comma separated)</label><input type="text" id="inPerson"></div>
        <div class="form-group"><label>çŠ¶æ€ Status</label><select id="inStatus"><option value="Planned">Planned (Blue)</option><option value="InProgress">In Progress (Orange)</option><option value="Done">Done (Green)</option><option value="Overdue" style="color:red; font-weight:bold;">âš ï¸ Overdue (Force Flag)</option></select></div>
        <div style="text-align:right; margin-top:30px;">
            <button class="btn" style="background:#edf2f7; color:#4a5568" onclick="closeModal()">Cancel</button>
            <button class="btn btn-add" style="margin-left:10px;" onclick="saveData()">Save to Cloud</button>
        </div>
    </div>
</div>

<div id="configModal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0">âš™ï¸ é…ç½®ä¸èŠ‚å‡æ—¥</h3>
        <div class="form-group"><label>Bin ID</label><input type="text" id="cfgBinId"></div>
        <div class="form-group"><label>API Key</label><input type="password" id="cfgApiKey"></div>
        
        <hr style="border:0; border-top:1px solid #eee; margin:20px 0;">
        
        <div class="form-group">
            <label>ğŸ§§ èŠ‚å‡æ—¥é…ç½® (YYYY-MM-DD, é€—å·åˆ†éš”)</label>
            <textarea id="cfgHolidays" rows="4" placeholder="ä¾‹å¦‚: 2026-01-01, 2026-01-02..."></textarea>
        </div>
        <div class="form-group">
            <label>ğŸ’¼ è°ƒä¼‘ä¸Šç­æ—¥é…ç½® (YYYY-MM-DD, é€—å·åˆ†éš”)</label>
            <textarea id="cfgMakeupDays" rows="2" placeholder="ä¾‹å¦‚: 2026-02-15..."></textarea>
        </div>

        <div style="text-align:right; margin-top:20px;">
            <button class="btn" style="background:#ddd; color:#333" onclick="closeConfigModal()">Cancel</button>
            <button class="btn btn-add" onclick="saveConfig()">Save Config</button>
        </div>
    </div>
</div>

<script>
    const REAL_BIN_ID = '692fd71bd0ea881f400f60b1';    
    const REAL_API_KEY = '$2a$10$qAHKdzsubRL5MD0cXJEm4OGuw68I0Ce7iVHGDyEj9FdPv5FFOIQ6q'; 
    let BIN_ID = localStorage.getItem('cs_work_bin_id') || REAL_BIN_ID; 
    let API_KEY = localStorage.getItem('cs_work_api_key') || REAL_API_KEY;
    let API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

    // é»˜è®¤æ•°æ® (å¦‚æœäº‘ç«¯æ²¡æœ‰é…ç½®ï¼Œåˆ™ä½¿ç”¨æ­¤é»˜è®¤å€¼)
    const DEFAULT_HOLIDAYS = [
        '2026-01-01', '2026-01-02', '2026-01-03', // å…ƒæ—¦
        '2026-02-15', '2026-02-16', '2026-02-17', '2026-02-18', '2026-02-19', '2026-02-20', '2026-02-21', '2026-02-22', '2026-02-23', // æ˜¥èŠ‚(9å¤©)
        '2026-04-04', '2026-04-05', '2026-04-06', // æ¸…æ˜
        '2026-05-01', '2026-05-02', '2026-05-03', '2026-05-04', '2026-05-05', // åŠ³åŠ¨èŠ‚
        '2026-06-19', '2026-06-20', '2026-06-21', // ç«¯åˆ
        '2026-09-25', '2026-09-26', '2026-09-27', // ä¸­ç§‹
        '2026-10-01', '2026-10-02', '2026-10-03', '2026-10-04', '2026-10-05', '2026-10-06', '2026-10-07' // å›½åº†
    ];
    const DEFAULT_MAKEUP_WORKDAYS = [
        '2026-02-14', '2026-02-28', // æ˜¥èŠ‚è°ƒä¼‘
        '2026-04-26', '2026-05-09', // åŠ³åŠ¨èŠ‚è°ƒä¼‘
        '2026-09-27', '2026-10-10'  // å›½åº†è°ƒä¼‘
    ];

    let appConfig = { holidays: DEFAULT_HOLIDAYS, makeupDays: DEFAULT_MAKEUP_WORKDAYS };
    const COLORS = { blue: '#63b3ed', teal: '#4fd1c5', green: '#68d391', orange: '#f6ad55', red: '#fc8181', purple: '#b794f4', gray: '#cbd5e0' };

    let workData = []; let isEditing = false; let chartInstances = {}; let currentPage = 1; const itemsPerPage = 12; let currentUser = "Guest";

    function checkLogin() {
        const input = document.getElementById('loginName').value.trim();
        if(input.length > 0) {
            currentUser = input; sessionStorage.setItem('current_user', currentUser); 
            document.getElementById('displayUser').innerText = currentUser;
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            if(checkConfig()) fetchData();
            else openConfigModal();
        } else { alert("è¯·å¡«å†™æ‚¨çš„å§“å"); }
    }
    if(sessionStorage.getItem('current_user')) {
        currentUser = sessionStorage.getItem('current_user'); document.getElementById('displayUser').innerText = currentUser;
        document.getElementById('loginOverlay').style.display = 'none'; document.getElementById('mainApp').style.display = 'block';
        if(checkConfig()) fetchData();
    }

    function normalizeDateStr(dateStr) {
        if (!dateStr) return '';
        let s = dateStr.trim(); const currentYear = new Date().getFullYear();
        if (s.includes('æœˆ')) { s = s.replace(/æ—¥/g, '').replace(/æœˆ/g, '/'); if (!s.includes('å¹´')) s = currentYear + '/' + s; else s = s.replace(/å¹´/g, '/'); } else { s = s.replace(/-/g, '/'); }
        const parts = s.split('/'); if(parts.length === 2) s = currentYear + '/' + s;
        const d = new Date(s); if(isNaN(d.getTime())) return '';
        const y = d.getFullYear(); const m = String(d.getMonth() + 1).padStart(2, '0'); const day = String(d.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
    }

    function getDateDisplay(start, end) {
        const s = normalizeDateStr(start); const e = normalizeDateStr(end); if (!s) return { html: '', raw: '' };
        const dateObj = new Date(s.replace(/-/g, '/')); const day = dateObj.getDay(); 
        const isMakeup = appConfig.makeupDays.includes(s);
        let badge = '';
        if (appConfig.holidays.includes(s)) badge = `<span class="tag tag-holiday">ğŸ§§ èŠ‚å‡æ—¥</span>`;
        else if (isMakeup) badge = `<span class="tag tag-makeup">ğŸ’¼ ç­ (è°ƒä¼‘)</span>`;
        else if (day === 0 || day === 6) badge = `<span class="tag tag-weekend">ğŸ–ï¸ å‘¨æœ«</span>`;
        let html = `<div>${badge} <b style="font-size:14px;color:#2d3748;font-family:inherit;">${s}</b></div>`;
        if (e && e !== s) {
            const d1 = new Date(s); const d2 = new Date(e); const diffTime = Math.abs(d2 - d1); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; 
            html += `<div style="margin-top:4px; font-size:12px; color:#718096;"><span>â¬‡ï¸ è‡³ ${e}</span><span class="tag tag-duration">ğŸ•’ ${diffDays}å¤©</span></div>`;
        }
        return { html: html, raw: s };
    }

    const today = new Date(); document.getElementById('schMonth').value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
    setInterval(() => { if(document.getElementById('mainApp').style.display === 'block' && BIN_ID && API_KEY && !isEditing) fetchData(); }, 60000); 

    function checkConfig() { if (!BIN_ID || !API_KEY) { updateStatus('âš ï¸ æœªé…ç½®'); return false; } return true; }
    function switchView(viewName) {
        document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.view-btn[onclick*="${viewName}"]`).classList.add('active');
        ['listView', 'dashboardView', 'kanbanView', 'schedulerView'].forEach(id => document.getElementById(id).classList.remove('show-view'));
        document.getElementById(viewName + 'View').classList.add('show-view');
        const schCtrl = document.getElementById('schedulerControls'); const comCtrl = document.getElementById('commonControls');
        if(viewName === 'scheduler') { schCtrl.style.display = 'flex'; comCtrl.style.display = 'none'; renderScheduler(); } else { schCtrl.style.display = 'none'; comCtrl.style.display = 'flex'; if(viewName === 'kanban') renderKanban(); if(viewName === 'dashboard') renderDashboard(); if(viewName === 'list') renderTable(); }
    }
    function enterPresentationMode() { switchView('scheduler'); const elem = document.documentElement; if (elem.requestFullscreen) { elem.requestFullscreen(); } else if (elem.webkitRequestFullscreen) { elem.webkitRequestFullscreen(); } else if (elem.msRequestFullscreen) { elem.msRequestFullscreen(); } }

    async function fetchData() {
        if(isEditing) return; updateStatus('ğŸ”„ åŒæ­¥ä¸­...');
        try { 
            const res = await fetch(API_URL, { headers: { 'X-Master-Key': API_KEY } }); 
            if(!res.ok) throw new Error("è¿æ¥å¤±è´¥"); 
            const json = await res.json(); 
            
            // æ•°æ®è§£æ
            if (json.record && json.record.tasks) { workData = json.record.tasks; }
            else if (json.tasks) { workData = json.tasks; } 
            else { workData = []; }

            // ğŸŸ¢ è¯»å–äº‘ç«¯é…ç½® (èŠ‚å‡æ—¥)
            if (json.record && json.record.config) {
                appConfig = json.record.config;
            } else {
                appConfig = { holidays: DEFAULT_HOLIDAYS, makeupDays: DEFAULT_MAKEUP_WORKDAYS }; // Fallback
            }

            if(document.getElementById('schedulerView').classList.contains('show-view')) renderScheduler(); else refreshView(); 
            updateStatus('âœ… å·²åŒæ­¥'); 
        } catch (e) { updateStatus('âŒ ' + e.message); }
    }

    function refreshView() { currentPage = 1; if(document.getElementById('listView').classList.contains('show-view')) renderTable(); if(document.getElementById('kanbanView').classList.contains('show-view')) renderKanban(); if(document.getElementById('dashboardView').classList.contains('show-view')) renderDashboard(); }

    function getFilteredData() {
        const search = document.getElementById('searchInput').value.toUpperCase(); const locFilter = document.getElementById('locFilter').value; const personFilter = document.getElementById('personFilter').value; const typeFilter = document.getElementById('typeFilter').value;
        let mapped = workData.map((item, idx) => ({ ...item, _id: idx }));
        let filtered = mapped.filter(item => { const str = (item.event+item.location+item.person+item.date+(item.tools||"")+(item.remarks||"")).toUpperCase(); return str.includes(search) && (locFilter === "" || item.location === locFilter) && (personFilter === "" || item.person.includes(personFilter)) && (typeFilter === "" || item.type === typeFilter); });
        filtered.sort((a, b) => { const d1Str = normalizeDateStr(a.date) || '2099-12-31'; const d2Str = normalizeDateStr(b.date) || '2099-12-31'; if (d1Str !== d2Str) return d1Str.localeCompare(d2Str); const t1 = (a.time || '00:00').split('-')[0].trim(); const t2 = (b.time || '00:00').split('-')[0].trim(); return t1.localeCompare(t2); }); return filtered;
    }

    function renderTable() {
        const tbody = document.getElementById('listBody'); const filtered = getFilteredData(); const totalItems = filtered.length; const totalPages = Math.ceil(totalItems / itemsPerPage) || 1; if(currentPage > totalPages) currentPage = totalPages; const startIdx = (currentPage - 1) * itemsPerPage; const endIdx = startIdx + itemsPerPage; const pageData = filtered.slice(startIdx, endIdx);
        document.getElementById('pageInfo').innerText = totalItems === 0 ? 'No data' : `Showing ${startIdx + 1}-${Math.min(endIdx, totalItems)} of ${totalItems}`; document.getElementById('prevBtn').disabled = currentPage === 1; document.getElementById('nextBtn').disabled = currentPage === totalPages; tbody.innerHTML = '';
        if(pageData.length === 0) { tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:60px;color:#a0aec0;"><div style="font-size:32px;margin-bottom:10px;opacity:0.6;">ğŸ“­</div><div>æš‚æ— ç›¸å…³ä»»åŠ¡æ•°æ® / No Data Found</div><button class="btn btn-add" onclick="openModal()" style="margin-top:15px; box-shadow:none;">+ Create New Task</button></td></tr>`; return; }
        const now = new Date(); const todayStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
        pageData.forEach(item => {
            const deadline = normalizeDateStr(item.endDate || item.date); const isOverdue = (item.status !== 'Done') && (item.status === 'Overdue' || (deadline && deadline < todayStr));
            let color = '#4299e1'; let statusDisplay = `â— ${item.status}`;
            if (item.status === 'Done') { color = '#48bb78'; statusDisplay = `â— Done`; } else if (isOverdue) { color = '#e53e3e'; const originStatus = item.status === 'Overdue' ? 'Task' : item.status; statusDisplay = `âš ï¸ Overdue <span style="font-size:10px;opacity:0.8">(${originStatus})</span>`; } else if (item.status === 'InProgress') { color = '#ed8936'; statusDisplay = `â— In Progress`; }
            let persons = item.person ? item.person.split(/,|ï¼Œ/).map(p => `<span class="tag tag-person">${p.trim()}</span>`).join('') : ''; const dateDisplay = getDateDisplay(item.date, item.endDate);
            tbody.innerHTML += `<tr><td style="line-height:1.6">${dateDisplay.html}<br><span style="color:#a0aec0;font-size:12px">${item.time||''}</span></td><td>${item.type === 'PM' ? '<span class="tag tag-type tag-pm">ğŸ› ï¸ PM</span>' : (item.type === 'Project' ? '<span class="tag tag-type tag-project">ğŸš§ æ–½å·¥</span>' : '<span class="tag tag-type tag-adhoc">âš¡ æŠ¢ä¿®</span>')}</td><td><span class="tag tag-loc">${item.location}</span></td><td style="font-weight:500">${item.event}</td><td style="color:#718096">${item.tools || '-'}</td><td style="color:#718096; font-style:italic">${item.remarks || '-'}</td><td>${persons}</td><td><span style="color:${color};font-weight:700">${statusDisplay}</span></td><td><div class="action-group"><button class="btn btn-edit" onclick="editItem(${item._id})">Edit</button><button class="btn btn-del" onclick="delItem(${item._id})">Del</button></div></td></tr>`;
        });
    }
    function changePage(delta) { currentPage += delta; renderTable(); }
    function exportToCSV() { const filtered = getFilteredData(); if(filtered.length === 0) return alert("æ²¡æœ‰æ•°æ®å¯å¯¼å‡º"); let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; csvContent += "Type,StartDate,EndDate,Time,Location,Event,Tools,Remarks,Person,Status\n"; filtered.forEach(row => { const rowStr = [ row.type || '', row.date || '', row.endDate || '', row.time || '', row.location || '', `"${(row.event || '').replace(/"/g, '""')}"`, `"${(row.tools || '').replace(/"/g, '""')}"`, `"${(row.remarks || '').replace(/"/g, '""')}"`, `"${(row.person || '').replace(/"/g, '""')}"`, row.status || '' ].join(","); csvContent += rowStr + "\n"; }); const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", `CS_Work_Export_${new Date().toISOString().slice(0,10)}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); }

    function renderKanban() {
        ['Planned', 'InProgress', 'Done', 'Overdue'].forEach(s => { document.getElementById(`col-${s}`).innerHTML=''; document.getElementById(`count-${s}`).innerText='0'; });
        const filtered = getFilteredData(); let counts = { Planned: 0, InProgress: 0, Done: 0, Overdue: 0 };
        const now = new Date(); const todayStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
        filtered.forEach(item => {
            let visualStatus = item.status || 'Planned'; const deadline = normalizeDateStr(item.endDate || item.date);
            if (visualStatus !== 'Done' && (visualStatus === 'Overdue' || (deadline && deadline < todayStr))) { visualStatus = 'Overdue'; }
            if(counts.hasOwnProperty(visualStatus)) counts[visualStatus]++; else counts['Planned']++; 
            const dateDisplay = getDateDisplay(item.date, item.endDate); const persons = item.person ? item.person.split(/,|ï¼Œ/).map(p => p.trim()).join(', ') : '';
            let dateStr = dateDisplay.raw; if(item.endDate && item.endDate !== item.date) dateStr += ` âœ ${normalizeDateStr(item.endDate)}`;
            const card = document.createElement('div'); card.className = `kanban-card card-${visualStatus}`; card.draggable = true; card.setAttribute('ondragstart', `drag(event, ${item._id})`);
            card.innerHTML = `<div class="k-title">${item.event}</div><div class="k-meta"><span>ğŸ“… ${dateStr}</span><span>ğŸ“ ${item.location}</span></div><div style="font-size:12px; color:#666; margin-bottom:5px;">${item.remarks || ''}</div><div class="k-footer"><span class="k-person">ğŸ‘¤ ${persons}</span><button class="btn-edit" style="border:none; cursor:pointer;" onclick="editItem(${item._id})">âœ</button></div>`;
            const col = document.getElementById(`col-${visualStatus}`) || document.getElementById(`col-Planned`); col.appendChild(card);
        });
        for(let k in counts) document.getElementById(`count-${k}`).innerText = counts[k];
    }
    function allowDrop(ev) { ev.preventDefault(); ev.currentTarget.classList.add('drag-over'); }
    function leaveDrop(ev) { ev.currentTarget.classList.remove('drag-over'); }
    function drag(ev, id) { ev.dataTransfer.setData("text", id); }
    async function drop(ev, newStatus) { ev.preventDefault(); ev.currentTarget.classList.remove('drag-over'); var taskId = ev.dataTransfer.getData("text"); if (workData[taskId] && workData[taskId].status !== newStatus) { workData[taskId].status = newStatus; refreshView(); updateStatus('ğŸ”„ åŒæ­¥çŠ¶æ€...'); try { await fetch(API_URL, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY }, body: JSON.stringify({ tasks: workData, config: appConfig }) }); updateStatus('âœ… å·²æ›´æ–°'); } catch(e) { updateStatus('âŒ å¤±è´¥'); } } }

    async function saveData() { const btn = document.querySelector('#taskModal .btn-add'); const origin = btn.innerText; btn.innerText='â³...'; btn.disabled=true; try { const res = await fetch(API_URL, { headers: { 'X-Master-Key': API_KEY } }); if(!res.ok) throw new Error("Err"); const json = await res.json(); let latestTasks = json.record.tasks || []; const idx = document.getElementById('editIndex').value; const task = { type: document.getElementById('inType').value, date: document.getElementById('inDate').value, endDate: document.getElementById('inEndDate').value, time: document.getElementById('inTime').value, location: document.getElementById('inLoc').value, event: document.getElementById('inEvent').value, person: document.getElementById('inPerson').value, status: document.getElementById('inStatus').value, tools: document.getElementById('inTools').value, remarks: document.getElementById('inRemarks').value }; if(idx === '-1') latestTasks.push(task); else latestTasks[idx] = task; workData = latestTasks; await fetch(API_URL, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY }, body: JSON.stringify({ tasks: workData, config: appConfig }) }); closeModal(); refreshView(); updateStatus('âœ… ä¿å­˜æˆåŠŸ'); } catch (e) { alert("Save Failed"); } finally { btn.innerText=origin; btn.disabled=false; } }
    async function delItem(idx) { if(!confirm("åˆ é™¤?")) return; try { const res = await fetch(API_URL, { headers: { 'X-Master-Key': API_KEY } }); const json = await res.json(); let tasks = json.record.tasks || []; if(tasks[idx]) { tasks.splice(idx, 1); workData = tasks; await fetch(API_URL, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY }, body: JSON.stringify({ tasks: workData, config: appConfig }) }); refreshView(); updateStatus('âœ… åˆ é™¤æˆåŠŸ'); } } catch (e) { alert("åˆ é™¤å¤±è´¥"); } }

    function renderScheduler() {
        const table = document.getElementById('schedulerTable');
        table.innerHTML = '';
        const monthVal = document.getElementById('schMonth').value; 
        if(!monthVal) return;
        const [year, month] = monthVal.split('-').map(Number);
        
        document.getElementById('schedulerTitle').innerText = `${year}å¹´ ${month}æœˆ æ’ç¨‹æ€»è§ˆ`;

        const daysInMonth = new Date(year, month, 0).getDate();
        const now = new Date();
        
        // ğŸŸ¢ æ˜ŸæœŸæ˜¾ç¤ºé€»è¾‘
        const WEEK_NAMES = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];

        let thead = '<thead><tr><th class="col-person" style="background:#fff;color:#2d3748;z-index:20">äººå‘˜ / æ—¥æœŸ</th>';
        for(let d=1; d<=daysInMonth; d++) {
            const dateObj = new Date(year, month-1, d);
            const isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6);
            const dateStr = `${year}-${String(month).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            
            // ğŸŸ¢ ä½¿ç”¨åŠ¨æ€é…ç½®çš„èŠ‚å‡æ—¥
            const isHoliday = appConfig.holidays.includes(dateStr);
            const isMakeup = appConfig.makeupDays.includes(dateStr); 
            const isToday = (year === now.getFullYear() && (month-1) === now.getMonth() && d === now.getDate());

            // è·å–æ˜ŸæœŸå­—ç¬¦ä¸²
            const weekStr = WEEK_NAMES[dateObj.getDay()];

            let bg = '#f8fafc'; // é»˜è®¤è¡¨å¤´èƒŒæ™¯ï¼ˆå·¥ä½œæ—¥ï¼‰
            let thClass = '';
            
            // ğŸŸ¢ é¢œè‰²åŠ æ·±é€»è¾‘
            if (isToday) { bg = ''; thClass = 'th-today'; }
            else if (isHoliday) bg = '#fed7d7';  /* æ˜æ˜¾ç²‰çº¢ */
            else if (isMakeup) bg = '#fff'; 
            else if (isWeekend) bg = '#fcebd0'; /* æ˜æ˜¾æ©™è‰² */
            
            // ğŸŸ¢ è¡¨å¤´ï¼šæ·»åŠ æ˜ŸæœŸæ˜¾ç¤º
            thead += `<th class="${thClass}" style="background:${bg}; min-width:36px;">
                        ${d}<br>
                        <span style="font-size:9px; font-weight:normal; opacity:0.8;">${weekStr}</span>
                      </th>`;
        }
        thead += '</tr></thead>';
        table.innerHTML += thead;

        let people = new Set();
        const indexedData = workData.map((item, index) => ({ ...item, _id: index }));
        workData.forEach(t => { if(t.person) t.person.split(/,|ï¼Œ/).forEach(p => people.add(p.trim())); });
        const personList = Array.from(people).sort();

        let tbody = '<tbody>';
        personList.forEach(p => {
            if(!p) return;
            tbody += `<tr><td class="col-person">${p}</td>`;
            for(let d=1; d<=daysInMonth; d++) {
                const dateObj = new Date(year, month-1, d);
                const isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6);
                const cellDateStr = `${year}-${String(month).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                
                // ğŸŸ¢ ä½¿ç”¨åŠ¨æ€é…ç½®
                const isHoliday = appConfig.holidays.includes(cellDateStr);
                const isMakeup = appConfig.makeupDays.includes(cellDateStr);
                const isToday = (year === now.getFullYear() && (month-1) === now.getMonth() && d === now.getDate());
                
                let cellClass = 'cell-clickable';
                if (isToday) cellClass += ' bg-today';
                else if (isHoliday) cellClass += ' bg-holiday';
                else if (isMakeup) cellClass += ' bg-makeup'; 
                else if (isWeekend) cellClass += ' bg-weekend';

                const tasks = indexedData.filter(t => {
                    const hasPerson = t.person && t.person.includes(p);
                    const start = normalizeDateStr(t.date); const end = normalizeDateStr(t.endDate) || start;
                    return hasPerson && cellDateStr >= start && cellDateStr <= end;
                });
                let content = '';
                tasks.forEach(t => {
                    let typeClass = t.type==='PM'?'sch-task-pm':(t.type==='Adhoc'?'sch-task-adhoc':''); if(t.status === 'Done') typeClass += ' sch-task-done';
                    content += `<div class="sch-task ${typeClass}" onclick="event.stopPropagation(); editItem(${t._id})"><span class="sch-task-text">${t.event}</span></div>`;
                });
                tbody += `<td class="${cellClass}" onclick="openModalWithDate('${cellDateStr}', '${p}')">${content}</td>`;
            }
            tbody += '</tr>';
        });
        tbody += '</tbody>';
        table.innerHTML += tbody;
    }

    function openModalWithDate(date, person) { openModal(); document.getElementById('inDate').value = date; document.getElementById('inPerson').value = person; }
    function renderDashboard() {
        const total = workData.length; const now = new Date(); const todayStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
        let done = 0; let inProgress = 0; let overdueCount = 0; let todayCount = 0;
        workData.forEach(task => {
            const dateStr = normalizeDateStr(task.date); const deadline = normalizeDateStr(task.endDate || task.date); const isDone = task.status === 'Done';
            if(dateStr === todayStr) todayCount++;
            if (isDone) { done++; } else if (task.status === 'Overdue' || (deadline && deadline < todayStr)) { overdueCount++; } else if (task.status === 'InProgress') { inProgress++; }
        });
        const plannedCount = total - done - inProgress - overdueCount;
        document.getElementById('kpi-today').innerText = todayCount; document.getElementById('kpi-overdue').innerText = overdueCount; document.getElementById('kpi-progress').innerText = inProgress; document.getElementById('kpi-done').innerText = done;
        let typeMap = { 'PM': 0, 'Project': 0, 'Adhoc': 0, 'Other': 0 }; let personMap = {}, locMap = {};
        workData.forEach(t => { let tType = t.type || 'Other'; if(typeMap.hasOwnProperty(tType)) typeMap[tType]++; else typeMap['Other']++; if(t.person) t.person.split(/,|ï¼Œ/).forEach(p => { let n = p.trim(); if(n) personMap[n] = (personMap[n] || 0) + 1; }); if(t.location) locMap[t.location] = (locMap[t.location] || 0) + 1; });
        renderChart('chartType', 'doughnut', ['PM (é¢„é˜²)', 'Project (æ–½å·¥)', 'Adhoc (æŠ¢ä¿®)', 'Other'], [typeMap['PM'], typeMap['Project'], typeMap['Adhoc'], typeMap['Other']], 'Type', [COLORS.teal, COLORS.purple, COLORS.orange, COLORS.gray]);
        renderChart('chartStatus', 'pie', ['Planned', 'InProgress', 'Done', 'Overdue'], [plannedCount, inProgress, done, overdueCount], 'Status', [COLORS.blue, COLORS.orange, COLORS.green, COLORS.red]);
        const sortedPersons = Object.entries(personMap).sort((a,b) => b[1] - a[1]).slice(0, 10); renderChart('chartPerson', 'bar', sortedPersons.map(p => p[0]), sortedPersons.map(p => p[1]), 'Tasks', COLORS.blue);
        const sortedLocs = Object.entries(locMap).sort((a,b) => b[1] - a[1]).slice(0, 10); renderChart('chartLoc', 'bar', sortedLocs.map(l => l[0]), sortedLocs.map(l => l[1]), 'Tasks', COLORS.purple);
    }
    function renderChart(id,t,l,d,lb,c){ const ctx=document.getElementById(id).getContext('2d'); if(chartInstances[id])chartInstances[id].destroy(); chartInstances[id]=new Chart(ctx,{type:t,data:{labels:l,datasets:[{label:lb,data:d,backgroundColor:c, borderColor:'#fff', borderWidth:2}]},options:{maintainAspectRatio:false, plugins:{legend:{labels:{font:{family:"'Inter', sans-serif"}}}}}}); }
    function updateDropdowns() { const ls=document.getElementById('locFilter'), ps=document.getElementById('personFilter'); if(ls.options.length<=1)[...new Set(workData.map(i=>i.location))].forEach(l=>ls.innerHTML+=`<option>${l}</option>`); if(ps.options.length<=1){let ns=[];workData.forEach(i=>i.person&&i.person.split(/,|ï¼Œ/).forEach(n=>ns.push(n.trim())));[...new Set(ns)].forEach(p=>ps.innerHTML+=`<option>${p}</option>`);}}
    function updateStatus(msg) { document.getElementById('syncStatus').innerText = msg; }
    function openModal() { document.getElementById('taskModal').style.display='block'; document.getElementById('editIndex').value='-1'; isEditing=true; if(document.getElementById('inPerson').value === '') { document.getElementById('inPerson').value = currentUser; } }
    function closeModal() { document.getElementById('taskModal').style.display='none'; isEditing=false; }
    function editItem(idx) { openModal(); const i=workData[idx]; document.getElementById('editIndex').value=idx; document.getElementById('inType').value=i.type || 'PM'; document.getElementById('inDate').value=i.date; document.getElementById('inEndDate').value=i.endDate || ''; document.getElementById('inTime').value=i.time; document.getElementById('inLoc').value=i.location; document.getElementById('inEvent').value=i.event; document.getElementById('inPerson').value=i.person; document.getElementById('inStatus').value=i.status; document.getElementById('inTools').value=i.tools; document.getElementById('inRemarks').value=i.remarks; }
    
    // ğŸŸ¢ é…ç½®ç›¸å…³é€»è¾‘
    function openConfigModal() { 
        document.getElementById('configModal').style.display='block'; 
        isEditing=true; 
        document.getElementById('cfgBinId').value = BIN_ID;
        // å¡«å……èŠ‚å‡æ—¥æ•°æ®åˆ°æ–‡æœ¬æ¡†
        document.getElementById('cfgHolidays').value = appConfig.holidays.join(', ');
        document.getElementById('cfgMakeupDays').value = appConfig.makeupDays.join(', ');
    }
    
    function closeConfigModal() { document.getElementById('configModal').style.display='none'; isEditing=false; }
    
    async function saveConfig() { 
        const nid=document.getElementById('cfgBinId').value.trim();
        const nkey=document.getElementById('cfgApiKey').value.trim();
        
        // è§£ææ–‡æœ¬æ¡†ä¸­çš„æ—¥æœŸ
        const hStr = document.getElementById('cfgHolidays').value;
        const mStr = document.getElementById('cfgMakeupDays').value;
        const newHolidays = hStr.split(/,|ï¼Œ/).map(s=>s.trim()).filter(s=>s.match(/^\d{4}-\d{2}-\d{2}$/));
        const newMakeupDays = mStr.split(/,|ï¼Œ/).map(s=>s.trim()).filter(s=>s.match(/^\d{4}-\d{2}-\d{2}$/));

        if(nid){
            localStorage.setItem('cs_work_bin_id',nid);
            if(nkey) localStorage.setItem('cs_work_api_key',nkey);
            BIN_ID=nid; API_KEY=nkey || API_KEY; API_URL=`https://api.jsonbin.io/v3/b/${BIN_ID}`;
            
            // æ›´æ–°æœ¬åœ°é…ç½®å¯¹è±¡
            appConfig.holidays = newHolidays;
            appConfig.makeupDays = newMakeupDays;

            // ä¿å­˜åˆ°äº‘ç«¯
            try {
                await fetch(API_URL, { 
                    method: 'PUT', 
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY }, 
                    body: JSON.stringify({ tasks: workData, config: appConfig }) 
                });
                alert("é…ç½®å·²ä¿å­˜!");
                closeConfigModal();
                fetchData();
            } catch(e) { alert("ä¿å­˜å¤±è´¥: " + e.message); }
        }
    }
</script>
</body>
</html>